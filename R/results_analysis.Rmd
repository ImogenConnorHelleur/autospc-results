---
title: "Results Analysis"
author: "Tom Woodcock"
date: "2023-11-27"
output: html_document
params:
  save_results: TRUE
  excluded_approaches: !r c("naive1", "naive2")
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r package-dependencies}
library(tidyverse)
```
```{r}
print(params$excluded_approaches)
```


Note that at present the repo is set up so that in this analysis (i.e. this
document) the "correct" time series are included for algorithm and naive3 (aka
re-establish at every shift) but NOT necessarily for naive1&2 - in particular 
it looks as though the monthly naive1 P charts include some that should not be
included - probably because the code that excludes series based on either number
of data points or midrange width needs updating for naive1. Since this does not
affect the paper I have left this for now (TW 9th Jan 2024).

```{r load-data}
full_results_all <- readRDS(file.path("..",
                                      "data",
                                      "outputs",
                                      "full_results",
                                      "full_results_all.rds")) %>% 
  separate_wider_delim(results_set, delim = " ", names = c("chart_type",
                                                           "approach"))
```

```{r}
full_results_all <- full_results_all %>%
  mutate(approach = case_when(
    approach == "algorithm" ~ "Stable Shift Algorithm",
    approach == "naive3" ~ "On Shift Rule Break",
    approach == "naive3b" ~ "On Shift Rule Break: Min. Period = 8",
    TRUE ~ approach
  ),
  approach = factor(str_wrap(approach, width = 20)),
  approach = fct_reorder(approach, -num_recalcs))

```

```{r}
full_results_all %>% 
  group_by(weeklyOrMonthly,
           chart_type,
           approach) %>% 
  summarise(num_series = n()) %>% 
  knitr::kable()

full_results_all %>% 
  group_by(chart_type,
           approach) %>% 
  summarise(num_series = n()) %>% 
  knitr::kable()

full_results_all %>% 
  group_by(weeklyOrMonthly,
           approach) %>% 
  summarise(num_series = n()) %>% 
  knitr::kable()
```

## Number of points
```{r}
full_results_all %>% 
  group_by(weeklyOrMonthly) %>% 
  summarise(num_series = n()/4,
            median = median(n),
            iqr = paste(quantile(n, 0.25),
                        " - ",
                        quantile(n, 0.75)),
            max_n = max(n),
            min_n = min(n)) %>% 
  knitr::kable()
```
```{r}
full_results_all %>% 
  filter(weeklyOrMonthly == "Weekly") %>% 
  group_by(n) %>% 
  summarise(num_series = n()/4) %>%
  knitr::kable()
```

```{r}
df <- full_results_all %>% 
    group_by(weeklyOrMonthly) %>% 
    mutate(mean_x = mean(n),
           median_x = median(n))

num_points_hist <- df %>% 
  ggplot(aes(x = n)) +
  geom_histogram(aes(y = after_stat(density*10)),
                 binwidth = 10,
                 colour = see::palette_okabeito(palette = "full")(9)[9],
                 fill = see::palette_okabeito(palette = "full")(9)[9],
                 alpha = 0.33) +
  facet_wrap(~ weeklyOrMonthly) +
  # geom_vline(aes(xintercept=median_x),
  #            colour = see::palette_okabeito(palette = "full")(9)[8],
  #            linetype = "solid",
  #            linewidth = 0.5) +
  scale_x_continuous(limits = c(0, NA),
                     oob = scales::oob_keep) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Number of points on chart",
       y = "Percentage of charts") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

num_points_hist
```


```{r}
my_hist <- function(df,
                    x,
                    binwidth = 1,
                    show_mean = FALSE,
                    xlab,
                    x_perc = FALSE,
                    scales_freedom = "fixed",
                    ymax = NA,
                    hist = TRUE) {
  
  my_palette <- see::palette_okabeito(palette = "full", order = c(2,3,6))(3)
  
  df <- df %>% 
    group_by(weeklyOrMonthly,
             approach) %>% 
    mutate(mean_x = mean({{ x }}),
           median_x = median({{ x }}))
  
  if(hist) {
    plt <- df %>% 
      ggplot(aes(x = {{ x }},
                 fill = approach)) +
      geom_histogram(aes(y = after_stat(density*binwidth),
                         colour = approach),
                     position = "identity",
                     alpha = 0.28,
                     binwidth = binwidth) +
      facet_wrap(~ weeklyOrMonthly,
                 scales = scales_freedom) +
      geom_vline(aes(xintercept=median_x,
                     colour = approach),
                 linetype = "solid", linewidth = 0.5) +
      scale_y_continuous(labels = scales::percent,
                         limits = c(0, ymax)) +
      # colScale +
      # fillScale +
      #see::scale_color_okabeito(guide = "none") +
      #see::scale_fill_okabeito(name = "Approach") +
      scale_color_manual(values = my_palette) +
      scale_fill_manual(values = my_palette) +
      labs(x = xlab,
           y = "Percentage of charts") +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  } else {
    plt <- df %>% 
      ggplot(aes(x = {{ x }},
                 fill = approach)) +
      geom_density(aes(
                         colour = approach),
                     position = "identity",
                     alpha = 0.33) +
      facet_wrap(~ weeklyOrMonthly,
                 scales = scales_freedom) +
      geom_vline(aes(xintercept=median_x,
                     colour = approach),
                 linetype = "solid", linewidth = 0.5) +
      scale_y_continuous(labels = scales::percent,
                         limits = c(0, ymax)) +
      # colScale +
      # fillScale +
      #see::scale_color_okabeito(guide = "none") +
      #see::scale_fill_okabeito(name = "Approach") +
      scale_color_manual(values = my_palette) +
      scale_fill_manual(values = my_palette) +
      labs(x = xlab,
           y = "Percentage of charts") +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
    
    
  }
  
  if(show_mean) {
    plt <- plt + geom_vline(aes(xintercept=mean_x,
                                colour = approach),
                            linetype = "dashed", linewidth = 0.5)
  }
  
  if(x_perc) {
    plt <- plt +
      scale_x_continuous(limits = c(0, NA),
                         labels = scales::percent,
                         oob = scales::oob_keep)
  } else {
    plt <- plt +
      scale_x_continuous(limits = c(0, NA),
                         oob = scales::oob_keep)
  }
  
  return(plt)
}


my_viol <- function(df,
                    y,
                    ylab,
                    y_perc = FALSE,
                    scales_freedom = "fixed",
                    ymax = NA) {
  
  my_palette <- see::palette_okabeito(palette = "full", order = c(2,3,6))(3)
  
  viol_plt <- df %>%
    ggplot(aes(x = approach,
               y ={{ y }})) +
    geom_violin(aes(color = approach,
                    fill = approach),
                adjust = 2.5,
                alpha = 0.33) +
    geom_boxplot(width=.15,
                 aes(color = approach,
                     fill = approach),
                 alpha = 0) +
    facet_wrap(~ weeklyOrMonthly,
               scales = scales_freedom) +
    scale_color_manual(values = my_palette) +
    scale_fill_manual(values = my_palette) + 
    labs(y = ylab) +
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
  
  
  if(y_perc) {
    viol_plt <- viol_plt +
      scale_y_continuous(limits = c(0, ymax),
                         labels = scales::percent,
                         oob = scales::oob_keep)
  } else {
    viol_plt <- viol_plt +
      scale_y_continuous(limits = c(0, ymax),
                         oob = scales::oob_keep)
  }
  
  return(viol_plt)
  
}

```

```{r}
summary_table <- function(df, x) {
  st <- df %>%
  filter(!(approach %in% params$excluded_approaches)) %>% 
  group_by(weeklyOrMonthly,
           approach) %>% 
  summarise(
    median = median({{ x }}),
    iqr = paste(quantile({{ x }}, 0.25),
                " - ",
                quantile({{ x }}, 0.75)),
    max_n = max({{ x }}),
    min_n = min({{ x }})
  ) %>%
  knitr::kable()
  
  return(st)
}
```


## Number of recalculations

```{r}
summary_table(full_results_all,
              x = num_recalcs)
```

```{r}
num_recalcs_hist <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_recalcs,
        xlab = "Number of times\nlimits re-established",
        binwidth = 1,
        scales_freedom = "free_x")

num_recalcs_hist
```

```{r}
num_recalcs_dens <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_recalcs,
        xlab = "Number of times\nlimits re-established",
        hist = FALSE,
        scales_freedom = "free")

num_recalcs_dens
```


```{r}
num_recalcs_viol <- my_viol(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        y = num_recalcs,
        ylab = "Number of times\nlimits re-established",
        scales_freedom = "free_y")

num_recalcs_viol
```



```{r}
summary_table(full_results_all,
              x = num_actual_recals_by_potential_recals)
```

```{r}
full_results_all <- full_results_all %>%
  mutate(num_recalcs_by_points = num_recalcs/n)

prop_recalcs_hist <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_recalcs_by_points,
        xlab = paste0("Number of times\nlimits re-established,\n",
                      "per point"),
        x_perc = TRUE,
        binwidth = 0.005,
        scales_freedom = "free_x")

prop_recalcs_hist
```

```{r}
prop_recalcs_dens <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_recalcs_by_points,
        xlab = paste0("Number of times\nlimits re-established,\n",
                      "per point"),
        hist = FALSE,
        scales_freedom = "free")

prop_recalcs_dens
```


```{r}
prop_recalcs_viol <- my_viol(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        y = num_recalcs_by_points,
        ylab = paste0("Number of times limits\nre-established,",
                      "per point"),
        scales_freedom = "free_y")

prop_recalcs_viol
```

## Remaining rule breaks

```{r}
summary_table(full_results_all,
              x = num_rule2_points)
```

```{r}
r2_pts_hist <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_rule2_points,
        xlab = "Number of points within shift rule breaks",
        binwidth = 5)

r2_pts_hist
```

```{r}
r2_pts_dens <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_rule2_points,
        xlab = "Number of points within shift rule breaks",
        hist = FALSE)

r2_pts_dens
```


```{r}
r2_pts_viol <- my_viol(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        y = num_rule2_points,
        ylab = "Number of points\nwithin shift rule breaks",
        scales_freedom = "free_y")

r2_pts_viol
```


```{r}
summary_table(full_results_all,
              x = num_rule2_breaks)
```

```{r}
r2_brks_hist <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_rule2_breaks,
        xlab = "Number of shift rule breaks",
        binwidth = 1)

r2_brks_hist
```

```{r}
r2_brks_dens <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_rule2_breaks,
        xlab = "Number of shift rule breaks",
        hist = FALSE)

r2_brks_dens
```


```{r}
r2_brks_viol <- my_viol(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        y = num_rule2_breaks,
        ylab = "Number of shift rule breaks")

r2_brks_viol
```

```{r}
summary_table(full_results_all,
              x = num_rule1_points)
```

```{r}
r1_pts_hist <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_rule1_points,
        xlab = "Number of points outside the control limits",
        binwidth = 5)

r1_pts_hist
```

```{r}
r1_pts_dens <- my_hist(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        x = num_rule1_points,
        xlab = "Number of points outside the control limits",
        hist = FALSE)

r1_pts_dens
```


```{r}
r1_pts_viol <- my_viol(full_results_all %>%
          filter(!(approach %in% params$excluded_approaches)),
        y = num_rule1_points,
        ylab = "Number of points\noutside the control limits")

r1_pts_viol
```

```{r fig.width = 5, fig.height=15}
combined_results <- ggpubr::ggarrange(num_points_hist,
                  num_recalcs_hist,
                  prop_recalcs_hist,
                  r2_brks_hist,
                  r2_pts_hist,
                  r1_pts_hist,
                  ncol = 1,
                  common.legend = TRUE,
                  legend = "bottom",
                  labels = "auto")

combined_results
```

```{r}
if(params$save_results) {
  ggsave(file.path("..", "plots", "combined_results.png"),
         plot = combined_results,
         width = 5,
         height = 15,
         units = "in")
}
```

```{r fig.width = 14, fig.height=6}
combined_results_wide <- ggpubr::ggarrange(
  num_points_hist,
  num_recalcs_hist + labs(y = NULL),
  prop_recalcs_hist + labs(y = NULL),
  r2_brks_hist,
  r2_pts_hist + labs(y = NULL),
  r1_pts_hist + labs(y = NULL),
  ncol = 3,
  nrow = 2,
  align = "hv",
  common.legend = TRUE,
  legend = "bottom",
  labels = "auto",
  label.x = 0.075,
  label.y = 1.025)

combined_results_wide
```

```{r fig.width = 14, fig.height=6}
combined_results_wide_dens <- ggpubr::ggarrange(
  num_points_hist,
  num_recalcs_dens + labs(y = NULL),
  prop_recalcs_dens + labs(y = NULL),
  r2_brks_dens,
  r2_pts_dens + labs(y = NULL),
  r1_pts_dens + labs(y = NULL),
  ncol = 3,
  nrow = 2,
  align = "hv",
  common.legend = TRUE,
  legend = "bottom",
  labels = "auto",
  label.x = 0.075,
  label.y = 1.025)

combined_results_wide_dens
```

```{r fig.width = 14, fig.height=6}
combined_results_wide_viol <- ggpubr::ggarrange(
  num_points_hist,
  num_recalcs_viol,
  prop_recalcs_viol,
  r2_brks_viol,
  r2_pts_viol,
  r1_pts_viol,
  ncol = 3,
  nrow = 2,
  align = "hv",
  common.legend = TRUE,
  legend = "bottom",
  labels = "auto",
  label.x = 0.075,
  label.y = 1.025)

combined_results_wide_viol
```


```{r}
if(params$save_results) {
  ggsave(file.path("..", "plots", "combined_results_wide_fig6.png"),
         plot = combined_results_wide,
         width = 14,
         height = 6,
         units = "in")
  
  ggsave(file.path("..", "plots", "combined_results_wide_fig6.tiff"),
         plot = combined_results_wide,
         width = 14,
         height = 6,
         units = "in",
         dpi = 300)
  
   ggsave(file.path("..", "plots", "combined_results_wide_dens_fig6.png"),
         plot = combined_results_wide_dens,
         width = 14,
         height = 6,
         units = "in")
  
  ggsave(file.path("..", "plots", "combined_results_wide_dens_fig6.tiff"),
         plot = combined_results_wide_dens,
         width = 14,
         height = 6,
         units = "in",
         dpi = 300)
  
  ggsave(file.path("..", "plots", "combined_results_wide_viol_fig6.png"),
         plot = combined_results_wide_viol,
         width = 14,
         height = 6,
         units = "in")
  
  ggsave(file.path("..", "plots", "combined_results_wide_viol_fig6.tiff"),
         plot = combined_results_wide_viol,
         width = 14,
         height = 6,
         units = "in",
         dpi = 300)
}
```
